<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="id_Title">Sensor</title>
    <link rel="stylesheet" href="Styles/dashboard_Sensor.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="shortcut icon" href="../site institucional/novo/assets/imgs/Logo_com fundo.png" type="image/x-icon">
</head>



<body>
    <div class="nav">

        <a href=""><img src="Assets/Icons/logo_branca.png" alt=""></a>


        <div>
            <a href="#">Home</a>
            <a href="#">Dashboard</a>
            <a href="#">Relatórios</a>
            <a href=""><img src="Assets/Icons/perfil.png" alt=""></a>
        </div>

    </div>


    <div class="container" id="div_container">

        <div class="KPI">
            <div class="Status">
                <h1>Dados em tempo real!</h1>
                <div>
                    <h4>Temperatura</h4>
                    <div>
                        <img src="Assets/Icons/termometro.png">
                        <h3><span id="tempSensorDash"></span>º</h3>
                    </div>
                </div>

                <div>
                    <h4>Umidade</h4>
                    <div>
                        <img src="Assets/Icons/umidade.png" class="perigo">
                        <h3><span id="umidSensorDash"></span>%</h3>
                    </div>
                </div>

                <div class="Situacao">
                    <h4>Situação</h4>
                    <div>
                        <img src="Assets/Icons/loading.gif" id="situacao_Dash" style="height: 70px; width: 70px;">
                    </div>
                </div>
            </div>

            <div class="Nome_Sensor">
                <h1>Sensor <span id="Nome_Sensor"></span></h1>
            </div>
        </div>


        <div class="graficos" id="div_grafico">

            <div class="Graf_Temp_Atuais">
                <div>
                    <h4>Temperatura em tempo real</h4>
                    <canvas id="myChart"></canvas>
                </div>

                <div>
                    <h4>Umidade em tempo real</h4>
                    <canvas id="myChart2"></canvas>
                </div>
            </div>
        </div>

        <div class="kpi_E_Manutencao" id="div_kpi">

            <div> </div>

            <div class="historicoAtencao">
                <h2>Ocorrências</h2>
                <div class="Ocorrencias" id="Ocorrencias"></div>
            </div>
        </div>


        <div class="aviso" id="div_aviso">

            <h1>Sensor em manutenção! Por favor retorne em outro momento.</h1>

        </div>

    </div>
    <div class="footer">

        <a href="dashboard.html"><img src="Assets/Icons/flecha.png"></a>

    </div>
</body>

</html>



<script>

    var id_sensor = sessionStorage.id_sensor;
    var limite = 3
    const ctx = document.getElementById('myChart');

    const ctx2 = document.getElementById('myChart2');


    const umidade = new Chart(ctx2, {
        type: 'line',
        data: {
            labels: ['0h', '1h', '2h', '3h', '4h', '5h', '6h', '7h',],
            datasets: [

                {
                    label: 'Aviso',
                    data: [],
                    borderWidth: 2,
                    borderColor: 'rgb(255, 251, 8)',
                    backgroundColor: 'rgb(255, 251, 8)',

                }
                , {
                    label: 'Alerta',
                    data: [],
                    borderWidth: 2,
                    borderColor: 'rgb(255, 0, 0)',
                    backgroundColor: 'rgb(255, 0, 0)',

                }
                , {
                    label: 'Umidade',
                    data: [],
                    borderWidth: 5,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgb(54, 162, 235)',
                }
                ,

            ]
        },
        options: {
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 30,
                        font: {
                            size: 14,
                            weight: 600,

                        },
                        color: 'rgb(26, 51, 32);'
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: 'rgb(26, 51, 32);',
                    }

                },
                y: {
                    ticks: {
                        color: 'rgb(26, 51, 32);'
                    },
                    beginAtZero: true
                },

            }
        }
    });


    const Temperatura = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['0h', '1h', '2h', '3h', '4h', '5h', '6h'],
            datasets: [
                {
                    label: 'Aviso',
                    data: [],
                    borderWidth: 2,
                    borderColor: 'rgb(255, 251, 8)',
                    backgroundColor: 'rgb(255, 251, 8)',
                }, {
                    label: 'Alerta',
                    data: [],
                    borderWidth: 2,
                    borderColor: 'rgb(255, 123, 0)',
                    backgroundColor: 'rgb(255, 123, 0)',
                },
                {
                    label: 'Incêndio',
                    data: [],
                    borderWidth: 2,
                    borderColor: 'rgb(255, 0, 0)',
                    backgroundColor: 'rgb(255, 0, 0)',
                },
                {
                    label: 'Temperatura',
                    data: [],
                    borderWidth: 5,
                    borderColor: 'rgb(0, 128, 0)',
                    backgroundColor: 'rgb(0, 128, 0)',
                },

            ]
        },
        options: {

            plugins: {
                legend: {

                    position: 'bottom',
                    labels: {
                        padding: 30,
                        font: {
                            size: 14,
                            weight: 600,

                        },
                        color: 'rgb(26, 51, 32);'
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: 'rgb(26, 51, 32);'
                    }
                },
                y: {
                    ticks: {
                        color: 'rgb(26, 51, 32);'
                    },
                    beginAtZero: true
                },

            }
        }
    });



    async function puxar_dados_sensor() {



        div_aviso.style.display = "none"

        const resp = await fetch(`/medidas/dados_sensor_especifico/${id_sensor}`)
        const resp_dados = await resp.json();
        await console.log(resp_dados)
        id_Title.innerHTML = "Dash:" + (Nome_Sensor.innerHTML = resp_dados[0].nome);

        tempSensorDash.innerHTML = resp_dados[0].temperatura
        umidSensorDash.innerHTML = resp_dados[0].umidade
        Nome_Sensor.innerHTML = resp_dados[0].nome
        Temperatura.data.datasets[0].data = []
        Temperatura.data.datasets[1].data = []
        Temperatura.data.datasets[2].data = []
        Temperatura.data.datasets[3].data = []
        umidade.data.datasets[0].data = []
        umidade.data.datasets[1].data = []
        umidade.data.datasets[2].data = []

        for (dados of resp_dados) {
            Temperatura.data.datasets[0].data.unshift(34)
            Temperatura.data.datasets[1].data.unshift(38)
            Temperatura.data.datasets[2].data.unshift(47)
            Temperatura.data.datasets[3].data.unshift(dados.temperatura)
            umidade.data.datasets[0].data.unshift(40)
            umidade.data.datasets[1].data.unshift(20)
            umidade.data.datasets[2].data.unshift(dados.umidade)

        }
        Temperatura.update()
        umidade.update()

        if (resp_dados[0].status_sensor == "Manutencao") {
            div_grafico.style.display = "none";
            div_kpi.style.display = "none";
            div_aviso.style.display = "flex"
            tempSensorDash.innerHTML = "Erro!"
            umidSensorDash.innerHTML = "Erro!"
        }



        /* ARRUMAR A INCONSISTÊNCIA DOS DADOS */

        if (resp_dados[0].Situacao_dado == "Alerta") {
            situacao_Dash.src = "Assets/Icons/alerta.png"

        } else if (resp_dados[0].Situacao_dado == "Perigo") {
            situacao_Dash.src = "Assets/Icons/perigo.png"
        } else if (resp_dados[0].status_sensor == "Manutencao") {

            situacao_Dash.src = "Assets/Icons/sem-sinal.png"

        } else {
            situacao_Dash.src = "Assets/grid_img/sensor.png"
        }

    }

    function Vermais() {
        limite += 3
        atualizar_ocorrencias()
    }


    async function atualizar_ocorrencias() {

        var resp = await fetch(`/medidas/atualizar_ocorrencias/${id_sensor}/${limite}`)
        const resp_dados = await resp.json();
        console.log(resp_dados)

        Ocorrencias.innerHTML = ``
        for (ocorre of resp_dados) {
            var data = new Date(ocorre.dtMedicao)
            var dia = String(data.getDate()).padStart(2, '0');
            var mes = String(data.getMonth() + 1).padStart(2, '0')
            var ano = data.getFullYear()
            if (ocorre.Situacao_dado == "Alerta") {
                Ocorrencias.innerHTML += `
                <div>
                        <img src="Assets/Icons/alerta.png" style="height: 60px; margin-left: 20px;">
                        <div>
                            <h3>Alerta de temperatura</h3>
                            <p>Temperatura em medidas críticas!. <br> Necessária tomada urgente de ação!</p>
                            <div>
                                <p>Data: <b>${dia}/${mes}/${ano}</b></p>
                            </div>
                        </div>
                </div>
                
                `
            }
            else if (ocorre.Situacao_dado == "Perigo") {
                Ocorrencias.innerHTML += `
                <div>
                        <img src="Assets/Icons/perigo.png" style="height: 60px; margin-left: 20px;">
                        <div>
                            <h3>Alerta de temperatura</h3>
                            <p>Temperatura e umidade <br>fora dos padrões normais. <br> Necessária tomada de ação!</p>
                            <div>
                                <p>Data: <b>${dia}/${mes}/${ano}</b></p>
                            </div>
                        </div>
                    </div>
                
                `
            }
            else {
                Ocorrencias.innerHTML += `
                <div>
                        <img src="Assets/grid_img/fogo.png" style="height: 60px; margin-left: 20px;">
                        <div>
                            <h3>Alerta de temperatura</h3>
                            <p>Temperatura está em um nível extremamente alto. <br>Sua tomada de ação precisa ser agora!</p>
                            <div>
                                <p>Data: <b>${dia}/${mes}/${ano}</b></p>
                            </div>
                        </div>
                    </div>
                `
            }
        }
        Ocorrencias.innerHTML += `<h5 onclick="Vermais()" style="cursor: pointer;">Ver mais...</h5>`
    }

    // {idSensor: 3, nome: 'A3-1', Situacao_dado: 'Alerta', dtMedicao: '2025-06-01T15:22:15.000Z'}

    // {idSensor: 3, nome: 'A3-1', Situacao_dado: 'Alerta', dtMedicao: '2025-06-01T15:20:39.000Z'}

    // {idSensor: 3, nome: 'A3-1', Situacao_dado: 'Alerta', dtMedicao: '2025-06-01T15:14:41.000Z'}


    function chamar() {
        setTimeout(() => {
            puxar_dados_sensor();
            chamar()
            atualizar_ocorrencias()
        }, 3000)
    }



    chamar()

</script>