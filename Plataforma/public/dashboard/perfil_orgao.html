<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix Eye | Perfil</title>
    <link rel="stylesheet" href="Styles/Perfil.css">
    <link rel="shortcut icon" href="assets/imgs/Logo_com fundo.png" type="image/x-icon">
</head>

<body>
    <div class="container">

        <div class="lateral">

            <img id="logo" src="Assets/Icons/logo_branca.png">

            <a onclick="mostrarPerfil()">
                <div id="Perfil">
                    <img src="Assets/Icons/Perfil-Orgao.png">
                    <h1 class="txt_botao">Perfil</h1>
                </div>
            </a>

            <a onclick="mostrarFunc()">
                <div id="FuncionarioLat">
                    <img src="Assets/Icons/Cracha.png">
                    <h1 class="txt_botao">Funcionario</h1>
                </div>
            </a>

            <a onclick="mostrarAPAs()">
                <div id="APA">
                    <img src="Assets/Icons/Floresta.png">
                    <h1 class="txt_botao">APAs</h1>
                </div>
            </a>

            <a onclick="mostrarAcessos()">
                <div id="Acessos">
                    <img src="Assets/Icons/relogio.png">
                    <h1 class="txt_botao">Acessos</h1>
                </div>
            </a>

            <a onclick="sair()">
                <div>
                    <img src="Assets/Icons/logout.png">
                    <h1 class="txt_botao">Logout</h1>
                </div>
            </a>

            <img id="voltar_org" onclick="voltar()" src="Assets/Icons/voltar.png">

        </div>

        <div class="Central" id="central">

            <!-- Aqui fica as divs De cadastro tanto de apa quanto de func -->
            <div class="cadastros" id="cadastros">

                <div class="cadastros_funcionarios" id="cadastro_func">
                    <div>
                        <h1>Adicionar os dados do seu funcionário:</h1>
                        <input type="text" placeholder="Nome:" id="input_nome">
                        <input type="text" placeholder="Email:" id="input_email">
                        <input type="text" placeholder="Senha:" id="input_senha">
                        <div>
                            <a onclick="ocultarCadastros()" style="cursor: pointer;">
                                <img src="Assets/Icons/seta.webp">
                            </a>
                            <button onclick="Cadastrar()">Cadastrar</button>
                            <div></div>
                        </div>
                    </div>
                </div>

                <div class="cadastros_funcionarios" id="atualizar_func">
                    <div>
                        <h1>Atualizar os dados do seu funcionário:</h1>
                        <input type="text" placeholder="Nome:" id="input_nome_atualizar">
                        <input type="text" placeholder="Email:" id="input_email_atualizar">
                        <input type="text" placeholder="Senha:" id="input_senha_atualizar">
                        <div>
                            <a onclick="ocultarCadastros()" style="cursor: pointer;">
                                <img src="Assets/Icons/seta.webp">
                            </a>
                            <button onclick="atualizar_funcionario()">Atualizar cadastro</button>
                            <div></div>
                        </div>
                    </div>
                </div>

                <div class="cadastros_APAs" id="cadastro_APAs">
                    <div>
                        <h1>Adicionar os dados da APA:</h1>
                        <input type="text" placeholder="Nome:" id="nome_apa">
                        <section>
                            <h1>Imagem:</h1>
                            <input type="file" placeholder="Imagem:" id="foto">
                        </section>

                        <input type="text" placeholder="Descrição:" id="descricao_apa">
                        <div>
                            <a onclick="ocultarCadastros()" style="cursor: pointer;">
                                <img src="Assets/Icons/seta.webp">
                            </a>
                            <button onclick="cadastrar_apa()">Cadastrar</button>
                            <div></div>
                        </div>
                    </div>
                </div>

                <div class="deletar_class" id="deletar">
                    <div>
                        <h1>Tem certeza que deseja deletar?</h1>

                        <div>
                            <a onclick="ocultarCadastros()" style="cursor: pointer;">
                                <img src="Assets/Icons/seta.webp">
                            </a>
                            <button onclick="deletar_func()">Deletar</button>
                            <div></div>
                        </div>
                    </div>
                </div>

                <div class="deletar_class" id="deletar_funcionario_div">
                    <div>
                        <h1>Tem certeza que deseja deletar?</h1>

                        <div>
                            <a onclick="ocultarCadastros()" style="cursor: pointer;">
                                <img src="Assets/Icons/seta.webp">
                            </a>
                            <button onclick="deletar_func()">Deletar</button>
                            <div></div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Divs para deletar -->

            <!-- Parte do perfil em si -->
            <div class="dados" id="dados">
                <div class="top_dados">
                    <img src="Assets/Icons/Perfil_dado.png">
                    <h1 id="titulo_orgao">Olá, </h1>
                </div>

                <div class="Centro_dados">
                    <div class="Dados_Cadastrados">
                        <h1>Dados:</h1>
                        <h1 id="nome_orgao">Nome:</h1>
                        <h1 id="email_orgao">Email:</h1>
                        <h1 id="telefone_orgao">Telefone:</h1>
                        <h1 id="cnpj_orgao">CNPJ:</h1>
                    </div>

                </div>

            </div>

            <!-- Parte dos funcionarios -->
            <div class="Funcionario" id="Funcionario">

                <div class="org_Acoes">
                    <div onclick="abrirCadastroFunc()" style="cursor: pointer;">
                        <img src="Assets/Icons/adicionar.png">
                        <h1>Adicionar</h1>
                    </div>
                </div>

                <div class="Lista_org">

                    <div class="Indicadores_org">
                        <h1>Nome</h1>
                        <h1>Email</h1>
                        <h1>Senha</h1>
                        <div></div>
                    </div>

                    <div class="listagem_org" id="listagem_org">

                    </div>

                </div>

            </div>

            <!-- Parte das APAs -->
            <div class="APAs" id="APAs">
                <div class="APAs_Acoes">
                    <div onclick=" abrirCadastroAPAs()" style="cursor: pointer;">
                        <img src="Assets/Icons/adicionar.png">
                        <h1>Adicionar</h1>
                    </div>

                </div>

                <div class="Lista_APAs">

                    <div class="Indicadores_APAs">
                        <div class="nula"></div>
                        <h1>Nome</h1>
                        <h1>Sensores</h1>
                        <h1>Status</h1>
                    </div>

                    <div class="listagem_APAs" id="listagem_APAs">


                    </div>

                </div>
            </div>


            <div class="Acesso" id="div_Acessos">

                <h1>Histórico de Acessos:</h1>

                <div class="lista_acessos" id="Listagem_acesso">

                </div>

            </div>


        </div>
    </div>
</body>

</html>

<script>
    const empresa = sessionStorage.idOrgao
    var funcionariosorg = []

    function dadosperfil() {
        fetch(`/perfil/dadosperfil/${empresa}`, {
            method: "get",
        })
            .then(resposta => {
                resposta.json().then(resposta => {
                    titulo_orgao.innerHTML += resposta[0].orgao
                    nome_orgao.innerHTML += resposta[0].orgao
                    email_orgao.innerHTML += resposta[0].email
                    telefone_orgao.innerHTML += resposta[0].telefone
                    cnpj_orgao.innerHTML += resposta[0].cnpj
                })
            })
            .catch(erro => {
                console.log(erro)
            })
    }

    function deletar_func() {
        var idfuncionario = sessionStorage.deletar_funcionario
        fetch(`/perfil/deletar_func/${idfuncionario}`, {
            method: "delete",
            headers: {
                "Content-Type": "application/json",
            }
        })
            .then(resposta => {
                resposta.json().then(resposta => {
                    sessionStorage.removeItem('deletar_funcionario');
                    listarfunc()
                    ocultarCadastros()
                })
            })
            .catch(erro => {
                console.log(erro)
            })
    }

    function atualizar_funcionario() {
        var idusuario = sessionStorage.Func_atualizar
        var nome = input_nome_atualizar.value
        var email = input_email_atualizar.value
        var senha = input_senha_atualizar.value
        fetch("/perfil/atualizar_funcionario", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idServer: idusuario,
                nomeServer: nome,
                emailServer: email,
                senhaServer: senha
            })
        })
            .then(resposta => resposta.json().then(resposta => {
                sessionStorage.removeItem('Func_atualizar');
                listarfunc()
                ocultarCadastros()
            }))
    }

    function listarfunc() {
        listagem_org.innerHTML = ""
        fetch(`/perfil/listarfunc/${empresa}`, {
            method: "GET",
        })
            .then(resposta => {
                resposta.json().then(resposta => {
                    funcionariosorg = resposta
                    for (resp of resposta) {
                        listagem_org.innerHTML += `<div id="${resp.idUsuario}">
                            <p>${resp.nome}</p>
                            <p>${resp.email}</p>
                            <p>${resp.senha}</p>
                            <div>
                                <img src="Assets/Icons/Engrenagem.png" onclick="abrirAtualizarFunc(${resp.idUsuario})">
                                <img src="Assets/Icons/Lixeira.png" onclick="abrir_deletar_func(${resp.idUsuario})">
                            </div>
                            </div>`
                    }
                })
            })
            .catch(erro => {
                console.log(erro)
            })
    }

    function cadastrando(nome, email, senha) {
        fetch(`/perfil/cadastrar`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                nomeServer: nome,
                emailServer: email,
                senhaServer: senha,
                idempresaServer: empresa
            }),
        })
            .then(resposta => {
                listarfunc()
            })
            .catch(erro => {
                console.log(erro)
            })
        ocultarCadastros()
    }



    function Cadastrar() {
        var nome = input_nome.value
        var email = input_email.value
        var senha = input_senha.value
        if (nome == '' || email == '' || senha == '') {
            alert('Erro')
        }
        else {
            fetch(`/perfil/checar_email/${email}`, {
                method: "GET",
                headers: { "Content-Type": "application/json" }
            })
                .then(resposta => {
                    resposta.json().then(resposta => {
                        if (resposta.length >= 1) {
                            alert("Erro email já cadastrado")
                        }
                        else {
                            cadastrando(nome, email, senha)
                            input_nome.value = ""
                            input_email.value = ""
                            input_senha.value = ""
                        }
                    })
                })
                .catch(erro => {
                    console.log(erro)
                })
        }
    }




    //listarapas


    function cadastrar_apa() {
        const form = new FormData()
        form.append('foto', foto.files[0])
        form.append('nome', nome_apa.value)
        form.append('idempresa', empresa)

        fetch("/perfil/cadastrar_apa", {
            method: "POST",
            body: form,
        })
            .then(resposta => {

                listarapas()
            })
            .catch(erro => {
                console.log(erro)
            })
        ocultarCadastros()

    }

    function listarapas() {
        listagem_APAs.innerHTML = ``
        fetch(`/perfil/listarapas/${empresa}`, {
            method: "GET"
        }).then(resposta => {
            resposta.json().then(resposta => {
                for (resp of resposta) {
                    listagem_APAs.innerHTML += `
                   <div>
                            <img src="${resp.Imagem}" class="imagem_APA">
                            <p>${resp.Nome_Atribuido}</p>
                            <p>32</p>
                            <img src="./Assets/Icons/${resp.Status_Monitoramento}.png" class="imagem_Situacao">                    
                    </div>
                   
                   `
                }
            })
        }).catch(erro => {
            console.log(erro)
        })

    }

    async function buscar_acessos() {

        const resp_acessos = await fetch(`/medidas/buscar_acessos/${sessionStorage.idOrgao}`)
        const dados_acessos = await resp_acessos.json();
        console.log(dados_acessos)
        var mensagem = "";


        for (var i = 0; i < dados_acessos.length; i++) {
            mensagem += `
                    <div>
                        <h1>${dados_acessos[i].nome}</h1>
                        <h1>${dados_acessos[i].Nome_Atribuido}</h1>
                        <h1>${dados_acessos[i].Data}</h1>
                    </div>

            `
        }
        Listagem_acesso.innerHTML = mensagem
    }


    function mostrarAcessos() {
        div_Acessos.style.display = "flex"
        Acessos.style.backgroundColor = "#024002";
        dados.style.display = "none";
        Funcionario.style.display = "none";
        APAs.style.display = "none";
        FuncionarioLat.style.backgroundColor = "transparent";
        Perfil.style.backgroundColor = "transparent";
        APA.style.backgroundColor = "transparent";
        buscar_acessos();
    }



    function mostrarPerfil() {
        div_Acessos.style.display = "none"
        dados.style.display = "flex";
        Acessos.style.backgroundColor = "transparent";
        Funcionario.style.display = "none";
        APAs.style.display = "none";
        FuncionarioLat.style.backgroundColor = "transparent";
        Perfil.style.backgroundColor = "#024002";
        APA.style.backgroundColor = "transparent";
    }

    function mostrarFunc() {
        div_Acessos.style.display = "none"
        APAs.style.display = "none"
        Acessos.style.backgroundColor = "transparent";
        dados.style.display = "none"
        Funcionario.style.display = "flex"
        FuncionarioLat.style.backgroundColor = "#024002";
        Perfil.style.backgroundColor = "transparent"
        APA.style.backgroundColor = "transparent";
        listarfunc()
    }

    function mostrarAPAs() {
        div_Acessos.style.display = "none"
        dados.style.display = "none"
        Acessos.style.backgroundColor = "transparent";
        Funcionario.style.display = "none"
        APAs.style.display = "flex"
        FuncionarioLat.style.backgroundColor = "transparent";
        Perfil.style.backgroundColor = "transparent"
        APA.style.backgroundColor = "#024002";
        listarapas()
    }


    function abrir_deletar_func(id_func) {
        sessionStorage.deletar_funcionario = id_func
        deletar_funcionario_div.style.display = "flex"
        cadastros.style.display = "flex"

    }

    function ocultarCadastros() {
        cadastro_func.style.display = "none"
        cadastro_APAs.style.display = "none"
        cadastros.style.display = "none"
        deletar.style.display = "none"
        input_nome.value = "";
        deletar_funcionario_div.style.display = "none"
        input_email.value = "";
        input_senha.value = "";
        deletar.style.display = "none"
        atualizar_func.style.display = "none"


    }
    function abrirdeletar(id) {
        sessionStorage.deletar = `${id}`
        deletar.style.display = "flex"
        cadastros.style.display = "flex"
    }
    function abrirCadastroFunc() {
        cadastro_func.style.display = "flex"
        cadastro_APAs.style.display = "none"
        cadastros.style.display = "flex"
    }

    function abrirAtualizarFunc(id_func) {
        atualizar_func.style.display = "flex"
        cadastros.style.display = "flex"
        var posicao = 0
        console.log(funcionariosorg)
        for (i = 0; i < funcionariosorg.length; i++) {
            if (funcionariosorg[i].idUsuario == id_func) {
                posicao = i
                break
            }
        }
        input_nome_atualizar.value = funcionariosorg[posicao].nome
        input_email_atualizar.value = funcionariosorg[posicao].email
        input_senha_atualizar.value = funcionariosorg[posicao].senha
        sessionStorage.Func_atualizar = id_func
    }

    function abrirCadastroAPAs() {
        cadastro_func.style.display = "none"
        cadastro_APAs.style.display = "flex"
        cadastros.style.display = "flex"
    }
    dadosperfil()
    mostrarPerfil();
    ocultarCadastros()

    function sair() {
        sessionStorage.clear();
        window.location.href = "../site institucional/login.html";
    }

</script>