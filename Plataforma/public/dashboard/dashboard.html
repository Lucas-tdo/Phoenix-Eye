<!DOCTYPE html>
<html lang="en">
<!-- teste -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="Styles/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="shortcut icon" href="../site institucional/novo/assets/imgs/Logo_com fundo.png" type="image/x-icon">
</head>

<body>
    <div class="nav">

        <a href=""><img src="Assets/Icons/logo_branca.png" alt=""></a>


        <div>
            <a href="./home_dash.html">Home</a>
            <a href="#">Dashboard</a>
            <a href="#">Relatórios</a>
            <img src="Assets/Icons/perfil.png" alt="" onclick="direcionar_perfil()">
        </div>

    </div>

    <div class="container">

        <div style="width: 100%; padding: 30px 0; display: flex;align-items: center; justify-content: center;">
            <h1 id="Nome_monitoramento" style="font-size: 60px; color: #1A3421;"></h1>
        </div>

        <div class="KPI">
            <div class="Status">
                <h1>Status dos Sensores</h1>
                <div>
                    <h4>Alertas</h4>
                    <div>
                        <img src="Assets/grid_img/aviso_temp_umid.png">
                        <h3 id="qtdAviso"></h3>
                    </div>
                </div>

                <div>
                    <h4>Perigo</h4>
                    <div>
                        <img src="Assets/grid_img/alerta_temp_umid.png" class="perigo">
                        <h3 id="qtdAlerta"></h3>
                    </div>
                </div>

                <div>
                    <h4>Manutenção</h4>
                    <div>
                        <img src="Assets/Icons/sem-sinal.png">
                        <h3 id="qtdManutencao"></h3>
                    </div>
                </div>
            </div>

            <div class="indicadores_grafico">
                <a href="../dashboard/dashboard_Sensor.html"></a>

                <div>
                    <h1>Alerta</h1>
                    <div>
                        <img id="metrica" src="Assets/Icons/alerta.png">
                        <img id="termometro" src="Assets/Icons/termometro.png">
                        <img id="umidade" src="Assets/Icons/umidade.png">
                        <h4 id="temperaturaMedia" style="display: none;"></h4>
                        <h3>34°C <br><br> 40%</h3>
                    </div>
                </div>


                <div>
                    <h1>Perigo</h1>
                    <div>
                        <img id="metrica" src="Assets/Icons/perigo.png">
                        <img id="termometro" src="Assets/Icons/termometro.png">
                        <img id="umidade" src="Assets/Icons/umidade.png">
                        <h4 id="umidadeMedia" style="display: none;"></h4>
                        <h3>38°C <br><br> 20%</h3>
                    </div>
                </div>

                <div>
                    <h1>Incêndio</h1>
                    <div>
                        <img id="metrica" src="Assets/grid_img/fogo.png">
                        <img id="termometro" src="Assets/Icons/termometro.png">
                        <img id="umidade" src="Assets/Icons/umidade.png">
                        <h4 id="metrica_incendio"></h4>
                        <h3>47°C <br><br> 20%</h3>
                    </div>
                </div>

            </div>
        </div>


        <div class="Graficos">
            <div class="areaGrid" id="grid">


                <div style="height: 100%; width: 100%;">
                    <img src="Assets/Icons/loading.gif" alt="">
                </div>

            </div>


            <div class="div_grafico">
                <canvas id="myChart"></canvas>
            </div>

        </div>
        <div class="Sensores">

            <div class="listSensores">
                <h2>Sensores</h2>
                <div class="Tabela_sensores" id="Listar_sensores">

                    <div>
                        <h1>Carregando...</h1>
                        <img src="Assets/Icons/loading.gif" alt="">
                    </div>

                </div>



            </div>


            <div class="KPI-Sensores">
                <div class="AtencaoSensores">
                    <h1>Atenção Necessária:</h1>
                    <div class="lista_Atencao" id="lista_atencao">

                    </div>
                </div>
            </div>


        </div>



    </div>


</body>

</html>



<script>



    function dashSensor() {
        window.location.href = "dashboard_Sensor.html";
    }

    function direcionar_perfil() {


        var nivel = sessionStorage.nivelusuario
        console.log(nivel)
        if (nivel == 1) {
            window.location.href = `./perfil_adm.html`
        }
        else if (nivel == 2) {
            window.location.href = `./perfil_funcionario.html`
        }
        else {
            window.location.href = `./perfil_orgao.html`
        }
    }


    async function buscar_dados_monitoramento() {
        var idMonitoramento = sessionStorage.idMonitoramento
        const resp = await fetch(`/medidas//dados_monitoramento/${idMonitoramento}`);
        if (resp.ok) {
            const resp_dados_monitoramento = await resp.json();
            
            grid.style.backgroundImage = `url("${resp_dados_monitoramento[0].Imagem}")`;
            Nome_monitoramento.innerHTML = resp_dados_monitoramento[0].Nome_Atribuido;
            listar_sensores(resp_dados_monitoramento)
        } else {
            console.error("Erro ao buscar dados:", resp.status);
        }   
    }


    async function buscarDados() {
        var idMonitoramento = sessionStorage.idMonitoramento
        const resp = await fetch(`/medidas/receber_dados/${idMonitoramento}`);
        if (resp.ok) {
            const resp_dados = await resp.json();

            console.log(resp_dados);
            listar_sensores(resp_dados)
        } else {
            console.error("Erro ao buscar dados:", resp.status);
        }        
    }



    function listar_sensores(resp_dados) {
        var mensagem = ""
        var lista_grid = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I'];
        var mensagem_grid = ''



        /*  Listando os sensores na lista */
        for (var i = 0; i < resp_dados.length; i++) {
            mensagem += `
            <div style = "cursor : pointer"onclick = "direcionar_pagina_individual(${resp_dados[i].ID})">
                <h1>${resp_dados[i].Nome_Sensor}</h1>
                <div>
                    <h1>${resp_dados[i].temperatura}C°</h1>
                    <h1>${resp_dados[i].umidade}%</h1>
                    <h1>${resp_dados[i].status_sensor}</h1>
                    <h1>${resp_dados[i].Situacao}</h1>
                </div>
            </div> 
            
           `;
        }
        console.log(resp_dados);
        /* Fazendo o gráfico de grid */


        var contador_alerta = 0;
        var contador_perigo = 0;
        var contador_manutencao = 0;

        var posicaoAtual = 0;
        for (var i = 0; i < lista_grid.length; i++) {

            posicaoAtual = lista_grid[i];
            mensagem_grid += `  
                    <div class = "${posicaoAtual}">
            `;
            for (var j = 1; j < 10; j++) {
                for (var k = 0; k < resp_dados.length; k++) {
                    if (resp_dados[k].Nome_Sensor.includes(`${posicaoAtual}${j}-${sessionStorage.idMonitoramento}`)) {
                        var inclui = true
                        var id = resp_dados[k].ID;

                        if (resp_dados[k].Situacao == "Alerta") {
                            contador_alerta++;
                        } else if (resp_dados[k].Situacao == "Perigo") {
                            contador_perigo++
                        } else if (resp_dados[k].status_sensor == "Manutencao") {
                            contador_manutencao++
                        }

                        break;
                    } else {
                        inclui = false
                    }
                }
                if (inclui) {

                    if (resp_dados[k].Situacao == "Alerta") {
                        mensagem_grid += `
                     <div id="${posicaoAtual}${j}-${sessionStorage.idMonitoramento}" onclick="direcionar_pagina_individual(${id})" style="cursor: pointer;">
                        <img src="Assets/Icons/alerta.png" alt="">
                    </div>
                    `
                    } else if (resp_dados[k].Situacao == "Perigo") {
                        mensagem_grid += `
                     <div id="${posicaoAtual}${j}-${sessionStorage.idMonitoramento}" onclick="direcionar_pagina_individual(${id})" style="cursor: pointer;">
                        <img src="Assets/Icons/perigo.png" alt="">
                    </div>
                    `
                    } else if (resp_dados[k].status_sensor == "Manutencao") {
                        mensagem_grid += `
                     <div id="${posicaoAtual}${j}-${sessionStorage.idMonitoramento}" onclick="direcionar_pagina_individual(${id})" style="cursor: pointer;">
                        <img src="Assets/Icons/sem-sinal.png" alt="">
                    </div>
                    `
                    } else {
                        mensagem_grid += `
                     <div id="${posicaoAtual}${j}-${sessionStorage.idMonitoramento}" onclick="direcionar_pagina_individual(${id})" style="cursor: pointer;">
                        <img src="Assets/grid_img/sensor.png" alt="">
                    </div>
                    `
                    }


                } else {
                    mensagem_grid += `<div></div>`
                }
            }

            mensagem_grid += "</div>"
        }



        grid.innerHTML = mensagem_grid
        qtdAviso.innerHTML = contador_alerta;
        qtdAlerta.innerHTML = contador_perigo;
        qtdManutencao.innerHTML = contador_manutencao;
        Listar_sensores.innerHTML = mensagem



        const ctx = document.getElementById('myChart');


        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['0h', '1h', '2h', '3h', '4h', '5h', '6h', '7h', '8h', '9h', '10h', '11h', '12h', '13h', '14h', '15h', '16h', '17h', '18h', '19h', '20h', '21h', '22h', '23h'],
                datasets: [
                    {
                        label: 'Umidade',
                        data: [47, 47, 47, 47, 47, 47, 47, 47, 47, 47],
                        borderWidth: 2,
                        borderColor: 'rgb(255, 0, 0)',
                        backgroundColor: 'rgb(255, 0, 0)',
                    },
                    {
                        label: 'Temperatura',
                        data: [],
                        borderWidth: 5,
                        borderColor: 'rgb(0, 128, 0)',
                        backgroundColor: 'rgb(0, 128, 0)',
                    },

                ]
            },
            options: {

                plugins: {
                    legend: {

                        position: 'bottom',
                        labels: {
                            padding: 30,
                            font: {
                                size: 14,
                                weight: 600,

                            },
                            color: 'rgb(26, 51, 32);'
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: 'rgb(26, 51, 32);'
                        }
                    },
                    y: {
                        ticks: {
                            color: 'rgb(26, 51, 32);'
                        },
                        beginAtZero: true
                    },

                }
            }
        });


    }





    setInterval(() => {
        buscarDados();
    }, 3000);




    function direcionar_pagina_individual(id_sensor) {
        sessionStorage.id_sensor = id_sensor;
        console.log(id_sensor)
        window.location = '../dashboard/dashboard_Sensor.html'
    }

    buscarDados();
    buscar_dados_monitoramento();

</script>



<!-- Caso precise lucas -->


<!--  <div class="A">
                    <div id="A1"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="A2"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="A3"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="A4"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="A5"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="A6"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="A7" onclick="dashSensor()" style="cursor: pointer;">
                        <img src="Assets/grid_img/sensor.png" alt="">
                    </div>
                    <div id="A8"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="A9"><img src="Assets/grid_img/sensor.png" alt=""></div>
                </div>


                <div class="B">
                    <div id="B1"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="B2"></div>
                    <div id="B3"></div>
                    <div id="B4"></div>
                    <div id="B5"></div>
                    <div id="B6"></div>
                    <div id="B7"></div>
                    <div id="B8"></div>
                    <div id="B9"><img src="Assets/grid_img/sensor.png" alt=""></div>
                </div>


                <div class="C">
                    <div id="C1"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="C2"></div>
                    <div id="C3"></div>
                    <div id="C4"></div>
                    <div id="C5"></div>
                    <div id="C6"></div>
                    <div id="C7"></div>
                    <div id="C8"></div>
                    <div id="C9"><img src="Assets/grid_img/sensor.png" alt=""></div>
                </div>


                <div class="D">
                    <div id="D1"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="D2"></div>
                    <div id="D3"></div>
                    <div id="D4"></div>
                    <div id="D5"></div>
                    <div id="D6"></div>
                    <div id="D7"></div>
                    <div id="D8"></div>
                    <div id="D9"><img src="Assets/grid_img/sensor.png" alt=""></div>
                </div>


                <div class="E">
                    <div id="E1"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="E2"></div>
                    <div id="E3"></div>
                    <div id="E4"></div>
                    <div id="E5"></div>
                    <div id="E6"></div>
                    <div id="E7"></div>
                    <div id="E8"></div>
                    <div id="E9"><img src="Assets/grid_img/sensor.png" alt=""></div>
                </div>


                <div class="F">
                    <div id="F1"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="F2"></div>
                    <div id="F3"></div>
                    <div id="F4"></div>
                    <div id="F5"></div>
                    <div id="F6"></div>
                    <div id="F7"></div>
                    <div id="F8"></div>
                    <div id="F9"><img src="Assets/grid_img/sensor.png" alt=""></div>
                </div>



                <div class="G">
                    <div id="G1"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="G2"></div>
                    <div id="G3"></div>
                    <div id="G4"></div>
                    <div id="G5"></div>
                    <div id="G6"></div>
                    <div id="G7"></div>
                    <div id="G8"></div>
                    <div id="G9"><img src="Assets/grid_img/sensor.png" alt=""></div>
                </div>


                <div class="H">
                    <div id="H1"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="H2"></div>
                    <div id="H3"></div>
                    <div id="H4"></div>
                    <div id="H5"></div>
                    <div id="H6"></div>
                    <div id="H7"></div>
                    <div id="H8"></div>
                    <div id="H9"><img src="Assets/grid_img/sensor.png" alt=""></div>
                </div>


                <div class="I">
                    <div id="I1"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="I2"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="I3"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="I4"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="I5"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="I6"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="I7"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="I8"><img src="Assets/grid_img/sensor.png" alt=""></div>
                    <div id="I9"><img src="Assets/grid_img/sensor.png" alt=""></div>
                </div>
 -->